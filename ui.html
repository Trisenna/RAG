<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒæ¨¡å¼RAGç³»ç»Ÿ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .chat-message {
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 10px;
            max-width: 80%;
        }
        .user-message {
            background-color: #e2f5fe;
            margin-left: auto;
        }
        .system-message {
            background-color: #f0f0f0;
            margin-right: auto;
        }
        .loading-dots:after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ' '; }
        }
        .event-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .event-meeting { background-color: #dbeafe; color: #1e40af; }
        .event-meal { background-color: #fef3c7; color: #92400e; }
        .event-travel { background-color: #d1fae5; color: #065f46; }
        .event-shopping { background-color: #ede9fe; color: #6b21a8; }
        .event-work { background-color: #fee2e2; color: #991b1b; }
        .event-social { background-color: #fce7f3; color: #a21caf; }
        .event-other { background-color: #f3f4f6; color: #374151; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-2">åŒæ¨¡å¼RAGç³»ç»Ÿ</h1>
        <p class="text-center text-gray-600 mb-8">æ”¯æŒæ–‡æ¡£çŸ¥è¯†æ£€ç´¢å’ŒèŠå¤©äº‹ä»¶æå–çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿ</p>

        <!-- ä¸»ä½“éƒ¨åˆ† - ä½¿ç”¨æ ‡ç­¾é¡µåˆ‡æ¢ä¸åŒåŠŸèƒ½ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex mb-4 border-b overflow-x-auto">
                <button id="tab-documents" class="tab-btn px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600 whitespace-nowrap">æ–‡æ¡£ç®¡ç†</button>
                <button id="tab-search" class="tab-btn px-4 py-2 font-medium text-gray-500 whitespace-nowrap">æ–‡æ¡£æ£€ç´¢</button>
                <button id="tab-events" class="tab-btn px-4 py-2 font-medium text-gray-500 whitespace-nowrap">äº‹ä»¶æœç´¢</button>
                <button id="tab-rag" class="tab-btn px-4 py-2 font-medium text-gray-500 whitespace-nowrap">RAGæŸ¥è¯¢</button>
                <button id="tab-contextual" class="tab-btn px-4 py-2 font-medium text-gray-500 whitespace-nowrap">ä¸Šä¸‹æ–‡å¯¹è¯</button>
                <button id="tab-statistics" class="tab-btn px-4 py-2 font-medium text-gray-500 whitespace-nowrap">ç³»ç»Ÿç»Ÿè®¡</button>
            </div>

            <!-- æ–‡æ¡£ç®¡ç†æ ‡ç­¾é¡µå†…å®¹ -->
            <div id="content-documents" class="tab-content">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4">ä¸Šä¼ æ–‡æ¡£</h2>
                    <div class="flex items-center">
                        <div class="flex-1 mr-4">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                <label for="file-upload" class="cursor-pointer">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <p class="mt-1 text-sm text-gray-600">
                                        ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„
                                    </p>
                                    <p class="mt-1 text-xs text-gray-500">
                                        æ”¯æŒèŠå¤©æ–‡ä»¶ï¼ˆ*_èŠå¤©.*ï¼‰å’Œæ™®é€šæ–‡æ¡£
                                    </p>
                                </label>
                                <input id="file-upload" type="file" class="hidden" />
                            </div>
                        </div>
                        <button id="btn-upload" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded">
                            ä¸Šä¼ æ–‡æ¡£
                        </button>
                    </div>
                    <div id="upload-result" class="mt-2 text-sm"></div>
                </div>

                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4">ç´¢å¼•ç®¡ç†</h2>
                    <div class="flex space-x-4">
                        <button id="btn-index-all" class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded">
                            ç´¢å¼•æ‰€æœ‰æ–‡æ¡£
                        </button>
                        <button id="btn-delete-indexes" class="bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded">
                            åˆ é™¤æ‰€æœ‰ç´¢å¼•
                        </button>
                        <button id="btn-recreate-indexes" class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded">
                            é‡å»ºç´¢å¼•
                        </button>
                    </div>
                    <div id="index-result" class="mt-2 text-sm"></div>
                </div>
            </div>

            <!-- æ–‡æ¡£æ£€ç´¢æ ‡ç­¾é¡µå†…å®¹ -->
            <div id="content-search" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4">æ–‡æ¡£æ£€ç´¢</h2>
                    <div class="flex items-center flex-wrap gap-4">
                        <input id="search-input" type="text" placeholder="è¾“å…¥æ£€ç´¢å…³é”®è¯..."
                               class="flex-1 min-w-64 border border-gray-300 rounded-lg px-4 py-2" />
                        <select id="search-type" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="intelligent" selected>æ™ºèƒ½æ£€ç´¢</option>
                            <option value="hybrid">æ··åˆæ£€ç´¢</option>
                            <option value="semantic">è¯­ä¹‰æ£€ç´¢</option>
                            <option value="keyword">å…³é”®è¯æ£€ç´¢</option>
                        </select>
                        <select id="search-topk" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="3">Top 3</option>
                            <option value="5" selected>Top 5</option>
                            <option value="10">Top 10</option>
                        </select>
                        <button id="btn-search" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded">
                            æ£€ç´¢
                        </button>
                    </div>
                </div>

                <div id="search-results" class="mt-6">
                    <!-- æœç´¢ç»“æœå°†åœ¨æ­¤åŠ¨æ€æ˜¾ç¤º -->
                </div>
            </div>

            <!-- äº‹ä»¶æœç´¢æ ‡ç­¾é¡µå†…å®¹ -->
            <div id="content-events" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4">äº‹ä»¶æœç´¢</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <input id="event-query" type="text" placeholder="æœç´¢äº‹ä»¶å†…å®¹..."
                               class="border border-gray-300 rounded-lg px-4 py-2" />
                        <select id="event-type" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="">æ‰€æœ‰äº‹ä»¶ç±»å‹</option>
                            <option value="meeting_plan">ä¼šè®®è®¡åˆ’</option>
                            <option value="meal_plan">ç”¨é¤è®¡åˆ’</option>
                            <option value="travel_plan">å‡ºè¡Œè®¡åˆ’</option>
                            <option value="shopping_plan">è´­ç‰©è®¡åˆ’</option>
                            <option value="entertainment_plan">å¨±ä¹è®¡åˆ’</option>
                            <option value="family_plan">å®¶åº­è®¡åˆ’</option>
                            <option value="work_task">å·¥ä½œä»»åŠ¡</option>
                            <option value="social_event">ç¤¾äº¤æ´»åŠ¨</option>
                            <option value="other_plan">å…¶ä»–è®¡åˆ’</option>
                        </select>
                        <input id="event-participants" type="text" placeholder="å‚ä¸è€…ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰..."
                               class="border border-gray-300 rounded-lg px-4 py-2" />
                        <select id="event-topk" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="5">Top 5</option>
                            <option value="10" selected>Top 10</option>
                            <option value="20">Top 20</option>
                        </select>
                    </div>
                    <div class="flex justify-center">
                        <button id="btn-search-events" class="bg-green-600 hover:bg-green-700 text-white font-medium px-6 py-2 rounded">
                            æœç´¢äº‹ä»¶
                        </button>
                    </div>
                </div>

                <div id="events-results" class="mt-6">
                    <!-- äº‹ä»¶æœç´¢ç»“æœå°†åœ¨æ­¤åŠ¨æ€æ˜¾ç¤º -->
                </div>
            </div>

            <!-- RAG æŸ¥è¯¢æ ‡ç­¾é¡µå†…å®¹ -->
            <div id="content-rag" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4">RAG æŸ¥è¯¢</h2>
                    <div class="mb-4">
                        <div class="flex space-x-4 mb-4">
                            <label class="flex items-center">
                                <input id="rag-decomposition" type="checkbox" checked class="mr-2">
                                æŸ¥è¯¢åˆ†è§£
                            </label>
                            <label class="flex items-center">
                                <input id="rag-reranking" type="checkbox" checked class="mr-2">
                                ç»“æœé‡æ’åº
                            </label>
                            <label class="flex items-center">
                                <input id="rag-citation" type="checkbox" checked class="mr-2">
                                å¼•ç”¨æ¥æº
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input id="rag-query" type="text" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
                                   class="flex-1 border border-gray-300 rounded-lg px-4 py-2 mr-4" />
                            <select id="rag-topk" class="border border-gray-300 rounded-lg px-4 py-2 mr-4">
                                <option value="3">Top 3</option>
                                <option value="5" selected>Top 5</option>
                                <option value="10">Top 10</option>
                            </select>
                            <button id="btn-rag-query" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded">
                                æŸ¥è¯¢
                            </button>
                        </div>
                    </div>
                </div>

                <div id="rag-result" class="mt-6">
                    <!-- RAG æŸ¥è¯¢ç»“æœå°†åœ¨æ­¤åŠ¨æ€æ˜¾ç¤º -->
                </div>
            </div>

            <!-- ä¸Šä¸‹æ–‡å¯¹è¯æ ‡ç­¾é¡µå†…å®¹ -->
            <div id="content-contextual" class="tab-content hidden">
                <div class="mb-4 flex space-x-4">
                    <button id="btn-new-session" class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded">
                        æ–°å»ºå¯¹è¯
                    </button>
                    <button id="btn-clear-session" class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium px-4 py-2 rounded">
                        æ¸…é™¤å¯¹è¯å†å²
                    </button>
                </div>

                <div class="mb-4">
                    <div class="flex space-x-4 mb-4">
                        <label class="flex items-center">
                            <input id="ctx-decomposition" type="checkbox" checked class="mr-2">
                            æŸ¥è¯¢åˆ†è§£
                        </label>
                        <label class="flex items-center">
                            <input id="ctx-reranking" type="checkbox" checked class="mr-2">
                            ç»“æœé‡æ’åº
                        </label>
                        <label class="flex items-center">
                            <input id="ctx-citation" type="checkbox" checked class="mr-2">
                            å¼•ç”¨æ¥æº
                        </label>
                    </div>
                </div>

                <!-- å¯¹è¯æ¶ˆæ¯åŒºåŸŸ -->
                <div id="chat-container" class="mb-4 h-96 border border-gray-200 rounded-lg p-4 overflow-y-auto">
                    <div id="chat-messages" class="flex flex-col">
                        <div class="chat-message system-message">
                            <p>æ‚¨å¥½ï¼æˆ‘æ˜¯åŸºäºåŒæ¨¡å¼çŸ¥è¯†åº“çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”æ–‡æ¡£é—®é¢˜å’ŒæŸ¥æ‰¾èŠå¤©äº‹ä»¶ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ</p>
                        </div>
                    </div>
                </div>

                <!-- å¯¹è¯è¾“å…¥åŒºåŸŸ -->
                <div class="flex items-center">
                    <input id="chat-input" type="text" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."
                           class="flex-1 border border-gray-300 rounded-lg px-4 py-2 mr-4" />
                    <button id="btn-send-message" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded">
                        å‘é€
                    </button>
                </div>
            </div>

            <!-- ç³»ç»Ÿç»Ÿè®¡æ ‡ç­¾é¡µå†…å®¹ -->
            <div id="content-statistics" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4">ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯</h2>
                    <button id="btn-refresh-stats" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded mb-4">
                        åˆ·æ–°ç»Ÿè®¡
                    </button>
                </div>

                <div id="statistics-content" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨æ­¤åŠ¨æ€æ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="flex justify-between items-center">
                <div>
                    <span id="system-status" class="inline-block h-3 w-3 rounded-full bg-green-500 mr-2"></span>
                    <span>ç³»ç»ŸçŠ¶æ€: </span>
                    <span id="status-text">åœ¨çº¿</span>
                </div>
                <div>
                    <span>ä¼šè¯ID: </span>
                    <span id="session-id">æœªåˆ›å»º</span>
                </div>
                <div>
                    <span>åŒæ¨¡å¼RAG v2.1.0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const API_BASE_URL = 'http://127.0.0.1:8000/api/v1';

        // çŠ¶æ€å˜é‡
        let currentSessionId = null;

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ ‡ç­¾é¡µåˆ‡æ¢
            initTabs();

            // åˆå§‹åŒ–å„åŠŸèƒ½æ¨¡å—
            initDocumentManagement();
            initSearch();
            initEventSearch();
            initRAGQuery();
            initContextualChat();
            initStatistics();

            // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            checkSystemStatus();
        });

        // åˆå§‹åŒ–æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ´»åŠ¨çŠ¶æ€
                    tabButtons.forEach(btn => {
                        btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                        btn.classList.add('text-gray-500');
                    });

                    // æ·»åŠ å½“å‰æ ‡ç­¾æŒ‰é’®çš„æ´»åŠ¨çŠ¶æ€
                    button.classList.remove('text-gray-500');
                    button.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');

                    // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });

                    // æ˜¾ç¤ºå½“å‰æ ‡ç­¾å¯¹åº”çš„å†…å®¹åŒºåŸŸ
                    const contentId = button.id.replace('tab-', 'content-');
                    document.getElementById(contentId).classList.remove('hidden');
                });
            });
        }

        // åˆå§‹åŒ–æ–‡æ¡£ç®¡ç†åŠŸèƒ½
        function initDocumentManagement() {
            const fileUploadInput = document.getElementById('file-upload');
            const uploadButton = document.getElementById('btn-upload');
            const indexAllButton = document.getElementById('btn-index-all');
            const deleteIndexesButton = document.getElementById('btn-delete-indexes');
            const recreateIndexesButton = document.getElementById('btn-recreate-indexes');
            const uploadResultDiv = document.getElementById('upload-result');
            const indexResultDiv = document.getElementById('index-result');

            // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            uploadButton.addEventListener('click', async () => {
                const file = fileUploadInput.files[0];
                if (!file) {
                    uploadResultDiv.innerHTML = '<p class="text-red-500">è¯·å…ˆé€‰æ‹©æ–‡ä»¶</p>';
                    return;
                }

                uploadResultDiv.innerHTML = '<p class="text-blue-500">æ­£åœ¨ä¸Šä¼ æ–‡æ¡£...</p>';

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${API_BASE_URL}/documents/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        const fileType = result.is_chat_file ? 'èŠå¤©æ–‡ä»¶' : 'æ™®é€šæ–‡æ¡£';
                        const typeIcon = result.is_chat_file ? 'ğŸ’¬' : 'ğŸ“„';
                        uploadResultDiv.innerHTML = `
                            <p class="text-green-500">
                                ${typeIcon} æ–‡æ¡£ "${result.filename}" ä¸Šä¼ æˆåŠŸï¼
                                <span class="text-sm text-gray-600">(è¯†åˆ«ä¸º: ${fileType})</span>
                            </p>
                        `;
                        fileUploadInput.value = '';
                    } else {
                        uploadResultDiv.innerHTML = `<p class="text-red-500">ä¸Šä¼ å¤±è´¥: ${result.detail || result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    }
                } catch (error) {
                    uploadResultDiv.innerHTML = `<p class="text-red-500">ä¸Šä¼ å‡ºé”™: ${error.message}</p>`;
                }
            });

            // ç´¢å¼•æ‰€æœ‰æ–‡æ¡£äº‹ä»¶
            indexAllButton.addEventListener('click', async () => {
                indexResultDiv.innerHTML = '<p class="text-blue-500">æ­£åœ¨ç´¢å¼•æ‰€æœ‰æ–‡æ¡£...</p>';

                try {
                    const response = await fetch(`${API_BASE_URL}/documents/index`, {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        const indexingResult = result.indexing_result || {};
                        const processedCount = indexingResult.processed_files || indexingResult.total_files || 0;
                        const successCount = indexingResult.successful_files || indexingResult.success_count || 0;
                        const failedCount = indexingResult.failed_files || indexingResult.failed_count || 0;

                        indexResultDiv.innerHTML = `<p class="text-green-500">ç´¢å¼•å®Œæˆ! å¤„ç†æ–‡æ¡£: ${processedCount}ä¸ªï¼ŒæˆåŠŸ: ${successCount}ä¸ªï¼Œå¤±è´¥: ${failedCount}ä¸ª</p>`;
                    } else {
                        indexResultDiv.innerHTML = `<p class="text-red-500">ç´¢å¼•å¤±è´¥: ${result.detail || result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    }
                } catch (error) {
                    indexResultDiv.innerHTML = `<p class="text-red-500">ç´¢å¼•å‡ºé”™: ${error.message}</p>`;
                }
            });

            // åˆ é™¤æ‰€æœ‰ç´¢å¼•äº‹ä»¶
            deleteIndexesButton.addEventListener('click', async () => {
                if (!confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ç´¢å¼•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤!')) {
                    return;
                }

                indexResultDiv.innerHTML = '<p class="text-blue-500">æ­£åœ¨åˆ é™¤æ‰€æœ‰ç´¢å¼•...</p>';

                try {
                    const response = await fetch(`${API_BASE_URL}/documents/indexes`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        indexResultDiv.innerHTML = `<p class="text-green-500">æ‰€æœ‰ç´¢å¼•å·²åˆ é™¤!</p>`;
                    } else {
                        indexResultDiv.innerHTML = `<p class="text-red-500">åˆ é™¤å¤±è´¥: ${result.detail || result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    }
                } catch (error) {
                    indexResultDiv.innerHTML = `<p class="text-red-500">åˆ é™¤å‡ºé”™: ${error.message}</p>`;
                }
            });

            // é‡å»ºç´¢å¼•äº‹ä»¶
            recreateIndexesButton.addEventListener('click', async () => {
                if (!confirm('ç¡®å®šè¦é‡å»ºæ‰€æœ‰ç´¢å¼•å—ï¼Ÿè¿™å°†åˆ é™¤ç°æœ‰ç´¢å¼•å¹¶é‡æ–°åˆ›å»ºã€‚')) {
                    return;
                }

                indexResultDiv.innerHTML = '<p class="text-blue-500">æ­£åœ¨é‡å»ºç´¢å¼•...</p>';

                try {
                    const response = await fetch(`${API_BASE_URL}/documents/indexes/recreate`, {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        indexResultDiv.innerHTML = `<p class="text-green-500">ç´¢å¼•é‡å»ºæˆåŠŸ!</p>`;
                    } else {
                        indexResultDiv.innerHTML = `<p class="text-red-500">é‡å»ºå¤±è´¥: ${result.detail || result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    }
                } catch (error) {
                    indexResultDiv.innerHTML = `<p class="text-red-500">é‡å»ºå‡ºé”™: ${error.message}</p>`;
                }
            });
        }

        // åˆå§‹åŒ–æ–‡æ¡£æ£€ç´¢åŠŸèƒ½
        function initSearch() {
            const searchInput = document.getElementById('search-input');
            const searchType = document.getElementById('search-type');
            const searchTopk = document.getElementById('search-topk');
            const searchButton = document.getElementById('btn-search');
            const searchResultsDiv = document.getElementById('search-results');

            searchButton.addEventListener('click', async () => {
                const query = searchInput.value.trim();
                if (!query) {
                    searchResultsDiv.innerHTML = '<p class="text-red-500">è¯·è¾“å…¥æ£€ç´¢å…³é”®è¯</p>';
                    return;
                }

                searchResultsDiv.innerHTML = '<p class="text-blue-500">æ­£åœ¨æ£€ç´¢ç›¸å…³æ–‡æ¡£...</p>';

                try {
                    const response = await fetch(`${API_BASE_URL}/documents/search?query=${encodeURIComponent(query)}&top_k=${searchTopk.value}&search_type=${searchType.value}`);
                    const result = await response.json();

                    if (response.ok) {
                        const searchResult = result.search_result || {};
                        const documents = searchResult.documents || searchResult.results || [];
                        const totalCount = searchResult.total_count || searchResult.count || documents.length;
                        const retrievalType = searchResult.retrieval_type || searchType.value;

                        if (documents && documents.length > 0) {
                            let html = `
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-semibold">æ‰¾åˆ° ${totalCount} ä¸ªç›¸å…³æ–‡æ¡£</h3>
                                    <span class="text-sm text-gray-500">æ£€ç´¢ç­–ç•¥: ${getRetrievalTypeName(retrievalType)}</span>
                                </div>
                            `;
                            html += '<div class="space-y-4">';

                            documents.forEach((doc, index) => {
                                const metadata = doc.metadata || {};
                                const title = metadata.title || metadata.filename || doc.filename || `æ–‡æ¡£ ${index + 1}`;
                                const source = metadata.source || doc.source || 'æœªçŸ¥';
                                const content = doc.content || doc.page_content || doc.text || '';
                                const score = doc.score || doc.similarity || 0;
                                const isEvent = metadata.is_event || false;
                                const eventType = metadata.event_type || '';

                                let typeTag = '';
                                if (isEvent) {
                                    typeTag = `<span class="event-tag event-${eventType.split('_')[0] || 'other'}">${getEventTypeName(eventType)}</span>`;
                                }

                                html += `
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <div class="flex items-center space-x-2">
                                                <h4 class="font-medium">${escapeHtml(title)}</h4>
                                                ${typeTag}
                                            </div>
                                            <span class="text-sm text-gray-500">ç›¸å…³åº¦: ${(score * 100).toFixed(2)}%</span>
                                        </div>
                                        <p class="text-gray-700">${escapeHtml(content.substring(0, 300))}${content.length > 300 ? '...' : ''}</p>
                                        <div class="mt-2 text-sm text-gray-500">
                                            <span>æ¥æº: ${escapeHtml(source)}</span>
                                        </div>
                                    </div>
                                `;
                            });

                            html += '</div>';
                            searchResultsDiv.innerHTML = html;
                        } else {
                            searchResultsDiv.innerHTML = '<p class="text-yellow-500">æœªæ‰¾åˆ°ç›¸å…³æ–‡æ¡£</p>';
                        }
                    } else {
                        searchResultsDiv.innerHTML = `<p class="text-red-500">æ£€ç´¢å¤±è´¥: ${result.detail || result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    }
                } catch (error) {
                    searchResultsDiv.innerHTML = `<p class="text-red-500">æ£€ç´¢å‡ºé”™: ${error.message}</p>`;
                }
            });
        }

        // åˆå§‹åŒ–äº‹ä»¶æœç´¢åŠŸèƒ½
        function initEventSearch() {
            const eventQuery = document.getElementById('event-query');
            const eventType = document.getElementById('event-type');
            const eventParticipants = document.getElementById('event-participants');
            const eventTopk = document.getElementById('event-topk');
            const searchEventsButton = document.getElementById('btn-search-events');
            const eventsResultsDiv = document.getElementById('events-results');

            searchEventsButton.addEventListener('click', async () => {
                const query = eventQuery.value.trim();
                const type = eventType.value;
                const participants = eventParticipants.value.trim();

                // è‡³å°‘éœ€è¦ä¸€ä¸ªæœç´¢æ¡ä»¶
                if (!query && !type && !participants) {
                    eventsResultsDiv.innerHTML = '<p class="text-red-500">è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªæœç´¢æ¡ä»¶</p>';
                    return;
                }

                eventsResultsDiv.innerHTML = '<p class="text-blue-500">æ­£åœ¨æœç´¢äº‹ä»¶...</p>';

                try {
                    let url = `${API_BASE_URL}/documents/search/events?top_k=${eventTopk.value}`;
                    if (query) url += `&query=${encodeURIComponent(query)}`;
                    if (type) url += `&event_type=${encodeURIComponent(type)}`;
                    if (participants) {
                        const participantList = participants.split(',').map(p => p.trim()).filter(p => p);
                        participantList.forEach(p => {
                            url += `&participants=${encodeURIComponent(p)}`;
                        });
                    }

                    const response = await fetch(url);
                    const result = await response.json();

                    if (response.ok) {
                        const events = result.events || [];

                        if (events.length > 0) {
                            let html = `
                                <div class="mb-4">
                                    <h3 class="font-semibold">æ‰¾åˆ° ${events.length} ä¸ªç›¸å…³äº‹ä»¶</h3>
                                </div>
                                <div class="space-y-4">
                            `;

                            events.forEach((event, index) => {
                                const eventTypeClass = event.event_type ? `event-${event.event_type.split('_')[0] || 'other'}` : 'event-other';
                                const eventTypeName = getEventTypeName(event.event_type);

                                html += `
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <div class="flex items-center space-x-2">
                                                <h4 class="font-medium">${escapeHtml(event.title || 'æœªå‘½åäº‹ä»¶')}</h4>
                                                <span class="event-tag ${eventTypeClass}">${eventTypeName}</span>
                                            </div>
                                            <span class="text-sm text-gray-500">ç›¸å…³åº¦: ${(event.score * 100).toFixed(2)}%</span>
                                        </div>
                                        <p class="text-gray-700 mb-2">${escapeHtml(event.content || '')}</p>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 text-sm text-gray-600">
                                            ${event.time ? `<div><strong>æ—¶é—´:</strong> ${escapeHtml(event.time)}</div>` : ''}
                                            ${event.location ? `<div><strong>åœ°ç‚¹:</strong> ${escapeHtml(event.location)}</div>` : ''}
                                            ${event.participants && event.participants.length > 0 ? `<div><strong>å‚ä¸è€…:</strong> ${event.participants.map(p => escapeHtml(p)).join(', ')}</div>` : ''}
                                            ${event.status ? `<div><strong>çŠ¶æ€:</strong> ${escapeHtml(event.status)}</div>` : ''}
                                        </div>
                                        ${event.source ? `<div class="mt-2 text-xs text-gray-500">æ¥æº: ${escapeHtml(event.source)}</div>` : ''}
                                    </div>
                                `;
                            });

                            html += '</div>';
                            eventsResultsDiv.innerHTML = html;
                        } else {
                            eventsResultsDiv.innerHTML = '<p class="text-yellow-500">æœªæ‰¾åˆ°ç›¸å…³äº‹ä»¶</p>';
                        }
                    } else {
                        eventsResultsDiv.innerHTML = `<p class="text-red-500">æœç´¢å¤±è´¥: ${result.detail || result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    }
                } catch (error) {
                    eventsResultsDiv.innerHTML = `<p class="text-red-500">æœç´¢å‡ºé”™: ${error.message}</p>`;
                }
            });
        }

        // åˆå§‹åŒ–RAGæŸ¥è¯¢åŠŸèƒ½
        function initRAGQuery() {
            const ragQuery = document.getElementById('rag-query');
            const ragTopk = document.getElementById('rag-topk');
            const ragDecomposition = document.getElementById('rag-decomposition');
            const ragReranking = document.getElementById('rag-reranking');
            const ragCitation = document.getElementById('rag-citation');
            const ragQueryButton = document.getElementById('btn-rag-query');
            const ragResultDiv = document.getElementById('rag-result');

            ragQueryButton.addEventListener('click', async () => {
                const query = ragQuery.value.trim();
                if (!query) {
                    ragResultDiv.innerHTML = '<p class="text-red-500">è¯·è¾“å…¥æŸ¥è¯¢é—®é¢˜</p>';
                    return;
                }

                ragResultDiv.innerHTML = '<p class="text-blue-500">æ­£åœ¨å¤„ç†æŸ¥è¯¢...</p>';

                const formData = new FormData();
                formData.append('query', query);
                formData.append('top_k', ragTopk.value);
                formData.append('use_decomposition', ragDecomposition.checked);
                formData.append('use_reranking', ragReranking.checked);
                formData.append('use_citation', ragCitation.checked);

                try {
                    const response = await fetch(`${API_BASE_URL}/rag/query`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        displayRAGResult(result.result, ragResultDiv);
                    } else {
                        ragResultDiv.innerHTML = `<p class="text-red-500">æŸ¥è¯¢å¤±è´¥: ${result.detail || result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    }
                } catch (error) {
                    ragResultDiv.innerHTML = `<p class="text-red-500">æŸ¥è¯¢å‡ºé”™: ${error.message}</p>`;
                }
            });
        }

        // æ˜¾ç¤ºRAGæŸ¥è¯¢ç»“æœ
        function displayRAGResult(result, container) {
            let html = `
                <div class="border border-gray-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold mb-2">å›ç­”:</h3>
                    <div class="whitespace-pre-wrap">${escapeHtml(result.answer || result.response || '')}</div>
                </div>
            `;

            // å¦‚æœæœ‰å¤„ç†ä¿¡æ¯ï¼Œæ˜¾ç¤ºå¤„ç†è¯¦æƒ…
            if (result.processing_info) {
                html += `
                    <div class="border border-gray-200 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold mb-2">å¤„ç†è¯¦æƒ…:</h3>
                        <div class="text-sm">
                `;

                const info = result.processing_info;
                if (info.original_query) {
                    html += `<p><strong>åŸå§‹æŸ¥è¯¢:</strong> ${escapeHtml(info.original_query)}</p>`;
                }
                if (info.rewritten_query) {
                    html += `<p><strong>é‡å†™æŸ¥è¯¢:</strong> ${escapeHtml(info.rewritten_query)}</p>`;
                }

                if (info.sub_queries && info.sub_queries.length > 0) {
                    html += `<p><strong>æŸ¥è¯¢å·²åˆ†è§£ä¸º ${info.sub_queries.length} ä¸ªå­æŸ¥è¯¢:</strong></p>`;
                    html += '<ul class="list-disc list-inside pl-4">';
                    info.sub_queries.forEach(sq => {
                        html += `<li>${escapeHtml(sq)}</li>`;
                    });
                    html += '</ul>';
                }

                html += `
                            <p><strong>æ£€ç´¢æ–‡æ¡£æ•°:</strong> ${info.retrieved_count || 0}</p>
                            <p><strong>æ˜¯å¦é‡æ’åº:</strong> ${info.reranked ? 'æ˜¯' : 'å¦'}</p>
                        </div>
                    </div>
                `;
            }

            // æ˜¾ç¤ºå¼•ç”¨æ¥æº
            if (result.sources && result.sources.length > 0) {
                html += `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">å¼•ç”¨æ¥æº:</h3>
                        <div class="space-y-2">
                `;

                result.sources.forEach((source, index) => {
                    const filename = source.filename || source.title || `æ¥æº ${index + 1}`;
                    const sourcePath = source.source || '';
                    const score = source.score || source.similarity || 0;
                    const content = source.content || source.page_content || source.text || '';
                    const isEvent = source.is_event || false;
                    const eventType = source.event_type || '';

                    let typeTag = '';
                    if (isEvent) {
                        typeTag = `<span class="event-tag event-${eventType.split('_')[0] || 'other'} ml-2">${getEventTypeName(eventType)}</span>`;
                    }

                    html += `
                        <div class="p-2 bg-gray-50 rounded">
                            <div class="flex justify-between items-center mb-1">
                                <div class="flex items-center">
                                    <span class="font-medium">${escapeHtml(filename)}</span>
                                    ${typeTag}
                                </div>
                                <span class="text-xs text-gray-500">ç›¸å…³æ€§åˆ†æ•°: ${score.toFixed(3)}</span>
                            </div>
                            ${content ? `<p class="text-sm text-gray-700 mb-2">${escapeHtml(content.substring(0, 200))}${content.length > 200 ? '...' : ''}</p>` : ''}
                            ${sourcePath ? `<p class="text-xs text-gray-600">è·¯å¾„: ${escapeHtml(sourcePath)}</p>` : ''}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            // æ˜¾ç¤ºå¤„ç†æ—¶é—´
            if (result.processing_time || result.elapsed_time) {
                const processingTime = result.processing_time || result.elapsed_time;
                html += `
                    <div class="mt-4 text-sm text-gray-500">
                        å¤„ç†æ—¶é—´: ${processingTime.toFixed(2)} ç§’
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // åˆå§‹åŒ–ä¸Šä¸‹æ–‡å¯¹è¯åŠŸèƒ½
        function initContextualChat() {
            const chatInput = document.getElementById('chat-input');
            const sendMessageButton = document.getElementById('btn-send-message');
            const chatMessages = document.getElementById('chat-messages');
            const newSessionButton = document.getElementById('btn-new-session');
            const clearSessionButton = document.getElementById('btn-clear-session');
            const sessionIdSpan = document.getElementById('session-id');
            const ctxDecomposition = document.getElementById('ctx-decomposition');
            const ctxReranking = document.getElementById('ctx-reranking');
            const ctxCitation = document.getElementById('ctx-citation');

            // åˆ›å»ºæ–°ä¼šè¯
            newSessionButton.addEventListener('click', async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/rag/contextual/session/new`, {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok && result.session_id) {
                        currentSessionId = result.session_id;
                        sessionIdSpan.textContent = currentSessionId;

                        // æ¸…ç©ºèŠå¤©æ¶ˆæ¯
                        chatMessages.innerHTML = `
                            <div class="chat-message system-message">
                                <p>æ–°ä¼šè¯å·²åˆ›å»ºï¼æˆ‘æ˜¯åŸºäºåŒæ¨¡å¼çŸ¥è¯†åº“çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”æ–‡æ¡£é—®é¢˜å’ŒæŸ¥æ‰¾èŠå¤©äº‹ä»¶ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ</p>
                            </div>
                        `;
                    } else {
                        addSystemMessage('åˆ›å»ºä¼šè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                } catch (error) {
                    addSystemMessage(`åˆ›å»ºä¼šè¯å‡ºé”™: ${error.message}`);
                }
            });

            // æ¸…é™¤ä¼šè¯å†å²
            clearSessionButton.addEventListener('click', async () => {
                if (!currentSessionId) {
                    addSystemMessage('æ²¡æœ‰æ´»åŠ¨ä¼šè¯ï¼Œè¯·å…ˆåˆ›å»ºä¼šè¯');
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('session_id', currentSessionId);

                    const response = await fetch(`${API_BASE_URL}/rag/contextual/session/clear`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        addSystemMessage('ä¼šè¯å†å²å·²æ¸…é™¤');
                    } else {
                        addSystemMessage('æ¸…é™¤ä¼šè¯å†å²å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                } catch (error) {
                    addSystemMessage(`æ¸…é™¤ä¼šè¯å†å²å‡ºé”™: ${error.message}`);
                }
            });

            // å‘é€æ¶ˆæ¯
            sendMessageButton.addEventListener('click', () => sendChatMessage());
            chatInput.addEventListener('keypress', event => {
                if (event.key === 'Enter') {
                    sendChatMessage();
                }
            });

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            function addUserMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message user-message';
                messageDiv.innerHTML = `<p>${escapeHtml(text)}</p>`;
                chatMessages.appendChild(messageDiv);
                scrollToBottom();
            }

            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            function addSystemMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message system-message';
                messageDiv.innerHTML = `<p>${text}</p>`;
                chatMessages.appendChild(messageDiv);
                scrollToBottom();
                return messageDiv.id;
            }

            // æ·»åŠ ç³»ç»Ÿæ­£åœ¨æ€è€ƒçš„æ¶ˆæ¯
            function addSystemThinkingMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message system-message';
                const id = 'thinking-' + Date.now();
                messageDiv.id = id;
                messageDiv.innerHTML = `<p>æ€è€ƒä¸­<span class="loading-dots"></span></p>`;
                chatMessages.appendChild(messageDiv);
                scrollToBottom();
                return id;
            }

            // ç§»é™¤æ¶ˆæ¯
            function removeMessage(id) {
                if (!id) return;
                const messageDiv = document.getElementById(id);
                if (messageDiv) {
                    messageDiv.remove();
                }
            }

            // ç»™æ¶ˆæ¯æ·»åŠ å¼•ç”¨
            function addCitationToLastMessage(result) {
                const sources = result.sources || [];
                if (!sources || sources.length === 0) {
                    return;
                }

                let citationHtml = '<div class="mt-2 text-xs text-gray-500"><details><summary>æŸ¥çœ‹å¼•ç”¨æ¥æº</summary><div class="mt-2 space-y-2">';

                sources.forEach((source, index) => {
                    if (typeof source === 'object') {
                        const title = source.filename || source.title || `æ¥æº ${index + 1}`;
                        const pageInfo = source.page || (source.metadata && source.metadata.page);
                        const content = source.content || source.page_content || source.text || '';
                        const score = source.score !== undefined ? `(ç›¸å…³åº¦åˆ†æ•°: ${source.score.toFixed(4)})` : '';
                        const sourcePath = source.source ? `<div class="text-xs opacity-50 mt-1">${source.source.split('/').pop()}</div>` : '';
                        const isEvent = source.is_event || false;
                        const eventType = source.event_type || '';

                        let typeTag = '';
                        if (isEvent) {
                            typeTag = `<span class="event-tag event-${eventType.split('_')[0] || 'other'} text-xs">${getEventTypeName(eventType)}</span>`;
                        }

                        citationHtml += `
                            <div class="p-2 bg-gray-100 rounded">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-medium">${escapeHtml(title)} ${score}</span>
                                        ${typeTag}
                                    </div>
                                    ${pageInfo ? `<span>é¡µç : ${pageInfo}</span>` : ''}
                                </div>
                                ${content ? `<p class="text-xs mt-1">${escapeHtml(content.substring(0, 150))}${content.length > 150 ? '...' : ''}</p>` : ''}
                                ${sourcePath}
                            </div>
                        `;
                    }
                });

                citationHtml += '</div></details></div>';

                const messages = document.querySelectorAll('#chat-messages .system-message');
                if (messages.length > 0) {
                    const lastMessage = messages[messages.length - 1];
                    lastMessage.innerHTML += citationHtml;
                }
            }

            // æ»šåŠ¨åˆ°åº•éƒ¨
            function scrollToBottom() {
                const chatContainer = document.getElementById('chat-container');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // å‘é€èŠå¤©æ¶ˆæ¯å‡½æ•°
            async function sendChatMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©çª—å£
                addUserMessage(message);
                chatInput.value = '';

                // æ·»åŠ ç³»ç»Ÿæ­£åœ¨æ€è€ƒçš„æ¶ˆæ¯
                const thinkingMsgId = addSystemThinkingMessage();

                // å‡†å¤‡è¡¨å•æ•°æ®
                const formData = new FormData();
                formData.append('query', message);
                if (currentSessionId) {
                    formData.append('session_id', currentSessionId);
                }
                formData.append('top_k', 5);
                formData.append('use_decomposition', ctxDecomposition.checked);
                formData.append('use_reranking', ctxReranking.checked);
                formData.append('use_citation', ctxCitation.checked);

                try {
                    const response = await fetch(`${API_BASE_URL}/rag/contextual/query`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    // ç§»é™¤æ­£åœ¨æ€è€ƒçš„æ¶ˆæ¯
                    removeMessage(thinkingMsgId);

                    if (response.ok) {
                        const ragResult = result.result || result;

                        // å¦‚æœæ˜¯æ–°ä¼šè¯ï¼Œä¿å­˜ä¼šè¯ID
                        if (ragResult.session_id && !currentSessionId) {
                            currentSessionId = ragResult.session_id;
                            sessionIdSpan.textContent = currentSessionId;
                        }

                        // æ·»åŠ ç³»ç»Ÿå›å¤æ¶ˆæ¯
                        const answer = ragResult.answer || ragResult.response || "";
                        addSystemMessage(answer);

                        // å¦‚æœå¯ç”¨äº†å¼•ç”¨ï¼Œåœ¨æ¶ˆæ¯ä¸‹æ–¹æ·»åŠ å¼•ç”¨æº
                        if (ctxCitation.checked && ragResult.sources && ragResult.sources.length > 0) {
                            addCitationToLastMessage(ragResult);
                        }
                    } else {
                        addSystemMessage(`æŸ¥è¯¢å¤±è´¥: ${result.detail || result.error || result.message || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                } catch (error) {
                    removeMessage(thinkingMsgId);
                    addSystemMessage(`å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: ${error.message}`);
                }
            }
        }

        // åˆå§‹åŒ–ç»Ÿè®¡ä¿¡æ¯åŠŸèƒ½
        function initStatistics() {
            const refreshStatsButton = document.getElementById('btn-refresh-stats');
            const statisticsContent = document.getElementById('statistics-content');

            refreshStatsButton.addEventListener('click', () => {
                loadStatistics();
            });

            // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½ç»Ÿè®¡ä¿¡æ¯
            loadStatistics();

            async function loadStatistics() {
                statisticsContent.innerHTML = '<div class="col-span-full text-center text-gray-500">æ­£åœ¨åŠ è½½ç»Ÿè®¡ä¿¡æ¯...</div>';

                try {
                    const response = await fetch(`${API_BASE_URL}/documents/statistics`);
                    const result = await response.json();

                    if (response.ok) {
                        displayStatistics(result);
                    } else {
                        statisticsContent.innerHTML = '<div class="col-span-full text-center text-red-500">åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥</div>';
                    }
                } catch (error) {
                    statisticsContent.innerHTML = `<div class="col-span-full text-center text-red-500">åŠ è½½ç»Ÿè®¡ä¿¡æ¯å‡ºé”™: ${error.message}</div>`;
                }
            }

            function displayStatistics(data) {
                const detailedStats = data.detailed_statistics || {};
                const breakdown = detailedStats.detailed_breakdown || {};
                const distribution = detailedStats.distribution_percentages || {};

                let html = `
                    <!-- æ€»ä½“ç»Ÿè®¡ -->
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <h3 class="font-bold text-blue-800 mb-4 text-lg">ğŸ“Š æ€»ä½“ç»Ÿè®¡</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span>æ€»æ–‡æ¡£å—æ•°:</span>
                                <span class="font-bold text-xl">${detailedStats.total_documents || 0}</span>
                            </div>

                            <div class="flex justify-between">
                                <span>æ–‡æ¡£æ–‡ä»¶å—:</span>
                                <span class="font-medium">${(detailedStats.total_documents || 0) - (detailedStats.chat_files || 0)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- è¯¦ç»†åˆ†ç±» -->
                    <div class="bg-green-50 p-6 rounded-lg">
                        <h3 class="font-bold text-green-800 mb-4 text-lg">ğŸ” è¯¦ç»†åˆ†ç±»</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span>äº‹ä»¶å—:</span>
                                <span class="font-bold text-purple-600">${breakdown.only_events || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>å‘½é¢˜å—:</span>
                                <span class="font-bold text-green-600">${breakdown.only_propositions || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>æ™®é€šå—:</span>
                                <span class="font-bold text-blue-600">${breakdown.only_regular || 0}</span>
                            </div>
                        </div>
                    </div>

                    <!-- å­˜å‚¨ä¿¡æ¯ -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="font-bold text-gray-800 mb-4 text-lg">ğŸ’¾ å­˜å‚¨ä¿¡æ¯</h3>
                        <div class="space-y-3 text-sm">
                            <div>
                                <div class="font-medium text-gray-700">ç´¢å¼•åç§°:</div>
                                <div class="text-xs break-all bg-white p-2 rounded mt-1">${data.search_statistics?.index_name || 'æœªçŸ¥'}</div>
                            </div>
                            <div>
                                <div class="font-medium text-gray-700">å‘é‡å­˜å‚¨:</div>
                                <div class="text-xs bg-white p-2 rounded mt-1">${data.search_statistics?.vector_store_type || 'elasticsearch'}</div>
                            </div>
                            <div>
                                <div class="font-medium text-gray-700">æ–‡æ¡£ç›®å½•:</div>
                                <div class="text-xs break-all bg-white p-2 rounded mt-1">${data.documents_directory || 'æœªçŸ¥'}</div>
                            </div>
                        </div>
                    </div>
                `;

                statisticsContent.innerHTML = html;
            }
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            const statusIndicator = document.getElementById('system-status');
            const statusText = document.getElementById('status-text');

            try {
                const response = await fetch(`http://127.0.0.1:8000/health`);
                const result = await response.json();

                if (response.ok && result.status === 'healthy') {
                    statusIndicator.className = 'inline-block h-3 w-3 rounded-full bg-green-500 mr-2';
                    statusText.textContent = 'åœ¨çº¿';
                } else {
                    statusIndicator.className = 'inline-block h-3 w-3 rounded-full bg-yellow-500 mr-2';
                    statusText.textContent = 'éƒ¨åˆ†å¯ç”¨';
                }
            } catch (error) {
                statusIndicator.className = 'inline-block h-3 w-3 rounded-full bg-red-500 mr-2';
                statusText.textContent = 'ç¦»çº¿';
                console.error('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // è¾…åŠ©å‡½æ•°
        function getEventTypeName(type) {
            const typeNames = {
                'meeting_plan': 'ä¼šè®®è®¡åˆ’',
                'meal_plan': 'ç”¨é¤è®¡åˆ’',
                'travel_plan': 'å‡ºè¡Œè®¡åˆ’',
                'shopping_plan': 'è´­ç‰©è®¡åˆ’',
                'entertainment_plan': 'å¨±ä¹è®¡åˆ’',
                'family_plan': 'å®¶åº­è®¡åˆ’',
                'work_task': 'å·¥ä½œä»»åŠ¡',
                'social_event': 'ç¤¾äº¤æ´»åŠ¨',
                'other_plan': 'å…¶ä»–è®¡åˆ’'
            };
            return typeNames[type] || type || 'æœªçŸ¥ç±»å‹';
        }

        function getRetrievalTypeName(type) {
            const typeNames = {
                'intelligent': 'æ™ºèƒ½æ£€ç´¢',
                'hybrid': 'æ··åˆæ£€ç´¢',
                'semantic': 'è¯­ä¹‰æ£€ç´¢',
                'keyword': 'å…³é”®è¯æ£€ç´¢'
            };
            return typeNames[type] || type || 'æœªçŸ¥ç­–ç•¥';
        }

        // HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>